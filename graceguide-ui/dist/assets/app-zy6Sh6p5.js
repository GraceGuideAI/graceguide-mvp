(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))o(a);new MutationObserver(a=>{for(const n of a)if(n.type==="childList")for(const i of n.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function s(a){const n={};return a.integrity&&(n.integrity=a.integrity),a.referrerPolicy&&(n.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?n.credentials="include":a.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function o(a){if(a.ep)return;a.ep=!0;const n=s(a);fetch(a.href,n)}})();const S=document.getElementById("ask"),B=document.getElementById("askLabel"),k=document.getElementById("spinner"),H=document.getElementById("question"),A=document.getElementById("sourceSlider"),M=document.getElementById("answerCard"),K=document.getElementById("output"),N=document.getElementById("sourceList"),T=document.getElementById("historyList"),P=document.querySelectorAll("#historyToggle"),p=document.getElementById("history"),y=document.getElementById("qaContainer"),R=document.getElementById("themeToggle"),G=document.documentElement;localStorage.theme==="dark"&&G.classList.add("dark");R.addEventListener("click",()=>{const e=G.classList.toggle("dark");localStorage.theme=e?"dark":"light"});const m=document.getElementById("emailModal"),w=document.getElementById("joinNow"),q=document.getElementById("joinLabel"),O=document.getElementById("joinSpinner"),D=document.getElementById("maybeLater"),b=document.getElementById("emailInput"),$=document.getElementById("closeModal"),f=document.getElementById("modalContent"),u=document.getElementById("shareModal"),L=document.getElementById("shareContent"),V=document.getElementById("sharePreview"),I=document.getElementById("downloadShare"),j=document.getElementById("downloadLabel"),W=document.getElementById("xShare"),Y=document.getElementById("instaShare"),z=document.getElementById("emailShare"),X=document.getElementById("closeShare");/Mobi/i.test(navigator.userAgent)?j.textContent="Save to Photos":j.textContent="Save Image";async function h(e){try{await fetch("/log_event",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({event:e})})}catch{}}let Q="both";A.addEventListener("input",()=>{const e=parseInt(A.value,10);Q=e===0?"both":e===1?"bible":"catechism"});let d=parseInt(localStorage.getItem("askCount")||"0",10),g=parseInt(localStorage.getItem("maybeLaterUntil")||"0",10);(d<5||d<g)&&sessionStorage.removeItem("modalShown");function Z(){console.log("Showing email modal"),m.classList.remove("hidden"),m.classList.remove("opacity-0"),f.classList.remove("opacity-0","scale-90"),requestAnimationFrame(()=>{m.classList.add("opacity-100"),f.classList.add("opacity-100","scale-100")}),h("modal_shown"),b.focus()}function C(){m.classList.remove("opacity-100"),m.classList.add("opacity-0"),f.classList.remove("opacity-100","scale-100"),f.classList.add("opacity-0","scale-90"),setTimeout(()=>{m.classList.add("hidden")},300)}function ee(){u.classList.remove("hidden"),u.classList.remove("opacity-0"),L.classList.remove("opacity-0","scale-90"),requestAnimationFrame(()=>{u.classList.add("opacity-100"),L.classList.add("opacity-100","scale-100")})}function te(){u.classList.remove("opacity-100"),u.classList.add("opacity-0"),L.classList.remove("opacity-100","scale-100"),L.classList.add("opacity-0","scale-90"),setTimeout(()=>{u.classList.add("hidden")},300)}function ae(e,t){const s=e.split(","),o=s[0].match(/:(.*?);/)[1],a=atob(s[1]);let n=a.length;const i=new Uint8Array(n);for(;n--;)i[n]=a.charCodeAt(n);return new File([i],t,{type:o})}async function ne(e,t){const s=document.createElement("div");s.className="share-card flex flex-col justify-between text-white rounded-lg overflow-hidden bg-gradient-to-br from-blue-900 to-blue-600 p-4 font-serif",s.style.width="540px",s.style.height="960px";const o=document.createElement("div");o.className="flex-1 flex flex-col justify-center gap-2 text-lg leading-tight overflow-hidden break-words";const a=document.createElement("p");a.innerHTML='<span class="font-semibold">Q:</span> '+e;const n=document.createElement("p");n.innerHTML='<span class="font-semibold">A:</span> '+t,o.appendChild(a),o.appendChild(n);const i=document.createElement("div");i.className="text-center text-sm opacity-80 mt-2",i.textContent="graceguide.ai",s.appendChild(o),s.appendChild(i),document.body.appendChild(s);const l=await html2canvas(s,{scale:2});return s.remove(),l.toDataURL("image/png")}let c;async function se(e,t){const s=await ne(e,t);c=ae(s,"graceguide.png"),V.src=s,I.href=s,ee()}function U(){const e=JSON.parse(localStorage.getItem("qaHistory")||"[]");T.innerHTML="",e.forEach(({q:t,a:s})=>{const o=document.createElement("li");o.className="history-item";const a=document.createElement("details"),n=document.createElement("summary");n.className="flex justify-between items-center";const i=document.createElement("span");i.className="question-text",i.textContent=t;const l=document.createElement("button");l.className="share-btn ml-2 text-brand flex-shrink-0",l.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-4 w-4"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5"/></svg>',l.addEventListener("click",J=>{J.stopPropagation(),se(t,s)}),n.appendChild(i),n.appendChild(l);const r=document.createElement("div");r.className="qa";const v=document.createElement("p");v.className="text-sm",v.innerHTML=`<span class="font-semibold">Question:</span> ${t}`;const E=document.createElement("p");E.className="mt-2 text-sm",E.innerHTML=`<span class="font-semibold">Answer:</span> ${s}`,r.appendChild(v),r.appendChild(E),a.appendChild(n),a.appendChild(r),o.appendChild(a),T.appendChild(o)})}U();async function _(){const e=H.value.trim();if(e){S.disabled=!0,B.classList.add("hidden"),k.classList.remove("hidden"),M.classList.add("hidden");try{const t=await fetch("/qa",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({question:e,mode:Q})});if(!t.ok)throw new Error(await t.text());const{answer:s,sources:o}=await t.json();K.textContent=s.trim(),N.innerHTML="",o.forEach(l=>{const r=document.createElement("li");r.textContent=l,N.appendChild(r)}),M.classList.remove("hidden");const a=JSON.parse(localStorage.getItem("qaHistory")||"[]");a.unshift({q:e,a:s.trim()}),a.splice(10),localStorage.setItem("qaHistory",JSON.stringify(a)),U(),d+=1,localStorage.setItem("askCount",d);const n=localStorage.getItem("subscribed");g=parseInt(localStorage.getItem("maybeLaterUntil")||"0",10),!n&&d>=5&&d>=g&&!sessionStorage.getItem("modalShown")&&(sessionStorage.setItem("modalShown","true"),Z())}catch(t){alert("Error: "+t.message)}finally{k.classList.add("hidden"),B.classList.remove("hidden"),S.disabled=!1}}}S.addEventListener("click",_);H.addEventListener("keydown",e=>{e.key==="Enter"&&(e.metaKey||e.ctrlKey)&&_()});w.addEventListener("click",async()=>{const e=b.value.trim();if(!e){alert("Please enter a valid email address."),b.focus();return}w.disabled=!0,q.classList.add("hidden"),O.classList.remove("hidden");try{const t=await fetch("/subscribe",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e})});if(!t.ok)throw new Error(await t.text());localStorage.setItem("subscribed","true"),C(),h("email_success")}catch(t){console.error("Subscription failed",t),alert("Subscription failed: "+t.message),h("email_failure")}finally{O.classList.add("hidden"),q.classList.remove("hidden"),w.disabled=!1}});D.addEventListener("click",()=>{g=d+10,localStorage.setItem("maybeLaterUntil",g),C(),h("maybe_later")});$.addEventListener("click",()=>{C(),h("modal_close")});const x=window.matchMedia("(min-width: 1024px)");function oe(){p.classList.remove("-translate-x-full"),x.matches&&y.classList.add("ml-72")}function F(){p.classList.add("-translate-x-full"),y.classList.remove("ml-72")}x.addEventListener("change",()=>{x.matches?p.classList.contains("-translate-x-full")||y.classList.add("ml-72"):y.classList.remove("ml-72")});function ie(e){!p.contains(e.target)&&![...P].some(t=>t.contains(e.target))&&F()}document.addEventListener("click",ie);P.forEach(e=>{e.addEventListener("click",()=>{p.classList.contains("-translate-x-full")?oe():F()})});X.addEventListener("click",te);W.addEventListener("click",async()=>{if(navigator.canShare&&navigator.canShare({files:[c]}))await navigator.share({files:[c],text:"GraceGuideAI Q&A"});else{const e="https://x.com/intent/tweet?text="+encodeURIComponent("GraceGuideAI Q&A");window.open(e,"_blank")}});Y.addEventListener("click",async()=>{navigator.canShare&&navigator.canShare({files:[c]})?await navigator.share({files:[c],text:"GraceGuideAI Q&A"}):alert("Your browser does not support direct image sharing. Please download the image and share manually.")});z.addEventListener("click",async()=>{navigator.canShare&&navigator.canShare({files:[c]})?await navigator.share({files:[c],title:"GraceGuideAI Q&A"}):window.location.href="mailto:?subject=GraceGuideAI%20Q%26A"});I.addEventListener("click",async e=>{if(navigator.canShare&&navigator.canShare({files:[c]})){e.preventDefault(),I.removeAttribute("download");try{await navigator.share({files:[c]})}catch{}}});
