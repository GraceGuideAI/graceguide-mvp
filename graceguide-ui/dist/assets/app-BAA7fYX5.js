(function(){const a=document.createElement("link").relList;if(a&&a.supports&&a.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))i(t);new MutationObserver(t=>{for(const n of t)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function s(t){const n={};return t.integrity&&(n.integrity=t.integrity),t.referrerPolicy&&(n.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?n.credentials="include":t.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(t){if(t.ep)return;t.ep=!0;const n=s(t);fetch(t.href,n)}})();const b=document.getElementById("ask"),C=document.getElementById("askLabel"),B=document.getElementById("spinner"),O=document.getElementById("question"),k=document.getElementById("sourceSlider"),N=document.getElementById("answerCard"),J=document.getElementById("output"),A=document.getElementById("sourceList"),T=document.getElementById("historyList"),j=document.querySelectorAll("#historyToggle"),f=document.getElementById("history"),L=document.getElementById("qaContainer"),D=document.getElementById("themeToggle"),G=document.documentElement;localStorage.theme==="dark"&&G.classList.add("dark");D.addEventListener("click",()=>{const e=G.classList.toggle("dark");localStorage.theme=e?"dark":"light"});const u=document.getElementById("emailModal"),w=document.getElementById("joinNow"),q=document.getElementById("joinLabel"),M=document.getElementById("joinSpinner"),K=document.getElementById("maybeLater"),S=document.getElementById("emailInput"),R=document.getElementById("closeModal"),v=document.getElementById("modalContent"),h=document.getElementById("shareModal"),E=document.getElementById("shareContent"),W=document.getElementById("sharePreview"),P=document.getElementById("downloadShare"),$=document.getElementById("downloadLabel"),V=document.getElementById("xShare"),Y=document.getElementById("instaShare"),z=document.getElementById("emailShare"),X=document.getElementById("closeShare");$.textContent="Download";async function y(e){try{await fetch("/log_event",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({event:e})})}catch{}}let H="both";k.addEventListener("input",()=>{const e=parseInt(k.value,10);H=e===0?"both":e===1?"bible":"catechism"});let m=parseInt(localStorage.getItem("askCount")||"0",10),g=parseInt(localStorage.getItem("maybeLaterUntil")||"0",10);(m<5||m<g)&&sessionStorage.removeItem("modalShown");function Z(){console.log("Showing email modal"),u.classList.remove("hidden"),u.classList.remove("opacity-0"),v.classList.remove("opacity-0","scale-90"),requestAnimationFrame(()=>{u.classList.add("opacity-100"),v.classList.add("opacity-100","scale-100")}),y("modal_shown"),S.focus()}function x(){u.classList.remove("opacity-100"),u.classList.add("opacity-0"),v.classList.remove("opacity-100","scale-100"),v.classList.add("opacity-0","scale-90"),setTimeout(()=>{u.classList.add("hidden")},300)}function ee(){h.classList.remove("hidden"),h.classList.remove("opacity-0"),E.classList.remove("opacity-0","scale-90"),requestAnimationFrame(()=>{h.classList.add("opacity-100"),E.classList.add("opacity-100","scale-100")})}function te(){h.classList.remove("opacity-100"),h.classList.add("opacity-0"),E.classList.remove("opacity-100","scale-100"),E.classList.add("opacity-0","scale-90"),setTimeout(()=>{h.classList.add("hidden")},300)}function ae(e,a){const s=e.split(","),i=s[0].match(/:(.*?);/)[1],t=atob(s[1]);let n=t.length;const o=new Uint8Array(n);for(;n--;)o[n]=t.charCodeAt(n);return new File([o],a,{type:i})}async function ne(e,a){const s=document.createElement("div");s.className="share-card flex flex-col justify-between text-white rounded-lg overflow-hidden bg-gradient-to-br from-blue-900 to-blue-600 p-8 font-serif",s.style.width="540px",s.style.height="960px";const i=document.createElement("div");i.className="text-3xl font-bold text-center mb-4",i.textContent="GraceGuideAI";const t=document.createElement("div");t.className="flex-1 flex flex-col justify-center gap-4 text-xl";const n=document.createElement("p"),o=document.createElement("span");o.className="font-semibold",o.textContent="Q:",n.appendChild(o),n.appendChild(document.createTextNode(" "+e)),n.style.overflowWrap="anywhere";const c=document.createElement("p"),l=document.createElement("span");l.className="font-semibold",l.textContent="A:",c.appendChild(l),c.appendChild(document.createTextNode(" "+a)),c.style.overflowWrap="anywhere",t.appendChild(n),t.appendChild(c);const d=document.createElement("div");d.className="text-center text-sm opacity-80 mt-4",d.textContent="graceguide.ai",s.appendChild(i),s.appendChild(t),s.appendChild(d),document.body.appendChild(s);const p=await html2canvas(s,{scale:2});return s.remove(),p.toDataURL("image/png")}let r;async function se(e,a){const s=await ne(e,a);r=ae(s,"graceguide.png"),W.src=s,P.href=s,ee()}function Q(){const e=JSON.parse(localStorage.getItem("qaHistory")||"[]");T.innerHTML="",e.forEach(({q:a,a:s})=>{const i=document.createElement("li");i.className="history-item";const t=document.createElement("details"),n=document.createElement("summary");n.className="flex justify-between items-center";const o=document.createElement("span");o.className="question-text",o.textContent=a;const c=document.createElement("button");c.className="share-btn ml-2 text-brand flex-shrink-0",c.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-4 w-4"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5"/></svg>',c.addEventListener("click",F=>{F.stopPropagation(),se(a,s)}),n.appendChild(o),n.appendChild(c);const l=document.createElement("div");l.className="qa";const d=document.createElement("p");d.className="text-sm",d.innerHTML=`<span class="font-semibold">Question:</span> ${a}`;const p=document.createElement("p");p.className="mt-2 text-sm",p.innerHTML=`<span class="font-semibold">Answer:</span> ${s}`,l.appendChild(d),l.appendChild(p),t.appendChild(n),t.appendChild(l),i.appendChild(t),T.appendChild(i)})}Q();async function U(){const e=O.value.trim();if(e){b.disabled=!0,C.classList.add("hidden"),B.classList.remove("hidden"),N.classList.add("hidden");try{const a=await fetch("/qa",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({question:e,mode:H})});if(!a.ok)throw new Error(await a.text());const{answer:s,sources:i}=await a.json();J.textContent=s.trim(),A.innerHTML="",i.forEach(c=>{const l=document.createElement("li");l.textContent=c,A.appendChild(l)}),N.classList.remove("hidden");const t=JSON.parse(localStorage.getItem("qaHistory")||"[]");t.unshift({q:e,a:s.trim()}),t.splice(10),localStorage.setItem("qaHistory",JSON.stringify(t)),Q(),m+=1,localStorage.setItem("askCount",m);const n=localStorage.getItem("subscribed");g=parseInt(localStorage.getItem("maybeLaterUntil")||"0",10),!n&&m>=5&&m>=g&&!sessionStorage.getItem("modalShown")&&(sessionStorage.setItem("modalShown","true"),Z())}catch(a){alert("Error: "+a.message)}finally{B.classList.add("hidden"),C.classList.remove("hidden"),b.disabled=!1}}}b.addEventListener("click",U);O.addEventListener("keydown",e=>{e.key==="Enter"&&(e.metaKey||e.ctrlKey)&&U()});w.addEventListener("click",async()=>{const e=S.value.trim();if(!e){alert("Please enter a valid email address."),S.focus();return}w.disabled=!0,q.classList.add("hidden"),M.classList.remove("hidden");try{const a=await fetch("/subscribe",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e})});if(!a.ok)throw new Error(await a.text());localStorage.setItem("subscribed","true"),x(),y("email_success")}catch(a){console.error("Subscription failed",a),alert("Subscription failed: "+a.message),y("email_failure")}finally{M.classList.add("hidden"),q.classList.remove("hidden"),w.disabled=!1}});K.addEventListener("click",()=>{g=m+10,localStorage.setItem("maybeLaterUntil",g),x(),y("maybe_later")});R.addEventListener("click",()=>{x(),y("modal_close")});const I=window.matchMedia("(min-width: 1024px)");function oe(){f.classList.remove("-translate-x-full"),I.matches&&L.classList.add("ml-72")}function _(){f.classList.add("-translate-x-full"),L.classList.remove("ml-72")}I.addEventListener("change",()=>{I.matches?f.classList.contains("-translate-x-full")||L.classList.add("ml-72"):L.classList.remove("ml-72")});function ie(e){!f.contains(e.target)&&![...j].some(a=>a.contains(e.target))&&_()}document.addEventListener("click",ie);j.forEach(e=>{e.addEventListener("click",()=>{f.classList.contains("-translate-x-full")?oe():_()})});X.addEventListener("click",te);V.addEventListener("click",async()=>{if(navigator.canShare&&navigator.canShare({files:[r]}))await navigator.share({files:[r],text:"GraceGuideAI Q&A"});else{const e="https://x.com/intent/tweet?text="+encodeURIComponent("GraceGuideAI Q&A");window.open(e,"_blank")}});Y.addEventListener("click",async()=>{navigator.canShare&&navigator.canShare({files:[r]})?await navigator.share({files:[r],text:"GraceGuideAI Q&A"}):alert("Your browser does not support direct image sharing. Please download the image and share manually.")});z.addEventListener("click",async()=>{navigator.canShare&&navigator.canShare({files:[r]})?await navigator.share({files:[r],title:"GraceGuideAI Q&A"}):window.location.href="mailto:?subject=GraceGuideAI%20Q%26A"});P.addEventListener("click",async e=>{if(navigator.canShare&&navigator.canShare({files:[r]})){e.preventDefault();try{await navigator.share({files:[r]})}catch{}}});
